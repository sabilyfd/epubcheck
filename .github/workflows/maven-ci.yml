name: build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:

  maven-verify:
    name: "Build with Java ${{ matrix.java }} on ${{matrix.os}}"
    strategy:
      matrix:
        os: [ubuntu-latest]
        java: [8, 11, 17, 21]
        include:
          - java: 21
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
    - name: "Checkout sources"
      uses: actions/checkout@v4
    - name: "Set up Java"
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: "temurin"
        cache: 'maven'
    - name: "Get Maven dependencies from cache"
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-maven-
    - name: "Build with Maven"
      run: mvn --batch-mode verify

  maven-deploy:
    name: "Deploy snapshot to Maven Central"
    needs: maven-verify
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout sources"
      uses: actions/checkout@v4
    - name: "Setup Java"
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: "temurin"
        server-id: central
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
    - name: "Get Maven dependencies from cache"
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-maven-
    - name: "Build and deploy to the Maven Central Repository"
      run: mvn --batch-mode -DskipTests deploy
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}